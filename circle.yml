machine:
  services:
    - docker

dependencies:
  pre:
    - pyenv global 2.7.12
    # Set up Google Cloud
    - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
    - sudo sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
    - sudo sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
    - sudo sudo /opt/google-cloud-sdk/bin/gcloud config set project $GCLOUD_PROJECT
    # Set up Docker
    # login so we can access private repo
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    # pull image from registry to cache docker layers for quicker rebuilds
    - docker pull ctippett/ticket-bounty-venue-api:latest || true
  override:
    # build new image
    - sudo sudo /opt/google-cloud-sdk/bin/gcloud container builds submit --tag us.gcr.io/$GCLOUD_PROJECT/venue-api .
    - docker pull us.gcr.io/$GCLOUD_PROJECT/venue-api:latest || true

test:
  override:
    - docker run us.gcr.io/$GCLOUD_PROJECT/venue-api test
    - docker run -d -p 8080:8080 us.gcr.io/$GCLOUD_PROJECT/venue-api # launch app in detached mode
    - curl --retry 10 --retry-delay 5 -v http://localhost:8080/api/_ah/health # test app is running on port 8080

deployment:
  production:
    branch: master
    commands:
      # -----------------------
      # Google Cloud Platform
      # -----------------------
      - docker tag -f ticket-bounty-venue-api us.gcr.io/$GCLOUD_PROJECT/venue-api:$CIRCLE_SHA1
      - sudo sudo /opt/google-cloud-sdk/bin/gcloud docker -- push us.gcr.io/$GCLOUD_PROJECT/venue-api:$CIRCLE_SHA1
      - docker tag -f ticket-bounty-venue-api us.gcr.io/$GCLOUD_PROJECT/venue-api:latest
      - sudo sudo /opt/google-cloud-sdk/bin/gcloud docker -- push us.gcr.io/$GCLOUD_PROJECT/venue-api:latest
      # Deploy
      - sudo sudo /opt/google-cloud-sdk/bin/gcloud app deploy --image-url us.gcr.io/$GCLOUD_PROJECT/venue-api:latest