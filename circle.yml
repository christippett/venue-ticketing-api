machine:
  services:
    - docker

dependencies:
  pre:
    - pyenv global 2.7.12
    # Set up Google Cloud
    - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
    - sudo sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
    - sudo sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
    - sudo sudo /opt/google-cloud-sdk/bin/gcloud config set project $GCLOUD_PROJECT
    # Set up Docker
    # login so we can access private repo
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    # pull image from registry to cache docker layers for quicker rebuilds
    - docker pull ctippett/ticket-bounty-venue-api:latest || true
  override:
    # build new image
    - docker build -t ticket-bounty-venue-api .

test:
  override:
    - docker run ticket-bounty-venue-api test
    - docker run -d -p 8080:8080 ticket-bounty-venue-api # launch app in detached mode
    - curl --retry 10 --retry-delay 5 -v http://localhost:8080/api/_ah/health # test app is running on port 8080

deployment:
  production:
    branch: master
    commands:
      # -----------------------
      # Docker Hub
      # -----------------------
      # Push the same image twice, once with the commit hash as the tag, and once with
      # 'latest' as the tag. 'latest' will always refer to the last image that was
      # built, since the next time this script is run, it'll get overridden. The
      # commit hash, however, is a constant reference to this image.
      - docker tag -f ticket-bounty-venue-api ctippett/ticket-bounty-venue-api:$CIRCLE_SHA1
      - docker push ctippett/ticket-bounty-venue-api:$CIRCLE_SHA1
      - docker tag -f ticket-bounty-venue-api ctippett/ticket-bounty-venue-api:latest
      - docker push ctippett/ticket-bounty-venue-api:latest
      # -----------------------
      # Google Cloud Platform
      # -----------------------
      - docker tag -f ticket-bounty-venue-api us.gcr.io/$GCLOUD_PROJECT/venue-api:$CIRCLE_SHA1
      - sudo sudo /opt/google-cloud-sdk/bin/gcloud docker -- push us.gcr.io/$GCLOUD_PROJECT/venue-api:$CIRCLE_SHA1
      - docker tag -f ticket-bounty-venue-api us.gcr.io/$GCLOUD_PROJECT/venue-api:latest
      - sudo sudo /opt/google-cloud-sdk/bin/gcloud docker -- push us.gcr.io/$GCLOUD_PROJECT/venue-api:latest
      # Deploy
      - sudo sudo /opt/google-cloud-sdk/bin/gcloud app deploy --image-url us.gcr.io/$GCLOUD_PROJECT/venue-api:latest